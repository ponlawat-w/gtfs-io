<!DOCTYPE html>
<html>
  <head>
    <title>GTFS</title>
    <meta charset="utf-8">
  </head>
  <body>
    <input id="file" type="file" multiple>
    <button id="download" type="button">Download</button>
    <textarea id="textarea" style="width: 100%; height: 75vh;" disabled></textarea>
    <script src="../dist/bundle/index.js"></script>
    <script lang="js">
      const file = document.getElementById('file');

      var FEED = undefined;

      const reset = () => {
        document.getElementById('textarea').value = '';
      };

      const writeLine = line => {
        document.getElementById('textarea').value += line + '\n';
      };

      const end = () => {
        document.getElementById('textarea').value += 'END\n';
      };

      const readFeed = async(feed) => {
        reset();
        FEED = new GTFSIO.GTFSLoadedFeed();
        for (const table of feed.getAllTables()) {
          const records = [];
          for await (const record of table.records) {
            records.push(record);
          }
          FEED.setTable(table.name, records);
          const line = `${table.name} = ${records.length}`;
          console.log(line);
          writeLine(line);
        }
        end();
      };

      const readZip = file => {
        const reader = new FileReader();
        reader.onload = async(e) => {
          const feed = await GTFSIO.GTFSAsyncFeedReader.fromZip(e.target.result).getFeed();
          readFeed(feed);
        };
        reader.readAsArrayBuffer(file);
      };

      const readFile = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          resolve(e.target.result);
        };
        reader.onerror = e => {
          reject(e);
        };
        reader.readAsText(file);
      });

      const readFiles = async(files) => {
        const fileContents = [];
        for (const file of files) {
          const content = await readFile(file);
          fileContents.push({ name: file.name, content });
        }
        const feed = await GTFSIO.GTFSAsyncFeedReader.fromFiles(fileContents).getFeed();
        readFeed(feed);
      };

      file.onchange = e => {
        const files = e.target.files;
        const zips = [...files].filter(x => x.type === 'application/x-zip-compressed');
        if (zips.length) {
          readZip(zips[0]);
          return;
        }
        const txts = [...files].filter(x => x.name.endsWith('.txt'));
        readFiles(files);
      };

      document.getElementById('download').onclick = async() => {
        if (!FEED) return;
        const zip = await GTFSIO.GTFSAsyncFeedWriter.createZip(FEED);

        const blob = new Blob([zip.toBuffer()], {
          type: 'application/x-zip-compressed'
        });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'gtfs.zip');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        a.remove();
      };
    </script>
  </body>
</html>
